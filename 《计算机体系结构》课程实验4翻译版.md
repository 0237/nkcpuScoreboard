# 实验4：记分板调度方法仿真
## 背景知识
<p>**记分牌**是CDC 6600计算机中使用的集中式方法，用于动态调度流水线，以便在没有冲突和硬件可用时指令可以执行无序。 在记分牌中，记录每条指令的数据依赖关系。 只有当记分板确定与先前发布和不完整的指令没有冲突时，才会发布说明。 如果由于不安全而导致指令停止，记分板将监视执行指令的流程，直到所有依赖关系在发出停止的指令之前得到解决。</p>

### 1. 阶段
<p>指令按顺序解码，并经过以下四个阶段。</p>

1. **发射：**系统检查该指令将读取和写入哪个寄存器。这些信息被记住，因为它将在以下阶段需要。 为了避免输出相关性（WAW - 写后写），指令停止，直到写入同一寄存器的指令完成。 当需要的功能单元当前正忙时，指令也停止。
2. **读取操作数：**指令发出并正确分配给所需的硬件模块后，指令将等待所有操作数变为可用。 此过程解决读取依赖性（RAW - 写后读），因为要写入另一条指令的寄存器在实际写入之前不被视为可用。
3. **执行：**当所有操作数都被取出时，功能单元开始执行。 结果准备就绪后，记分牌被通知。
4. **写入结果：**在此阶段，结果将被写入其目的寄存器。 但是，此操作会被延迟，直到早期的指令（意图读取此指令要写入的寄存器）已完成其读操作数阶段。 这样就可以解决所谓的数据依赖（WAR - 读后写）。

### 2. 数据结构
<p>为了控制指令的执行，记分板维护三个状态表：</p>

- **指令状态：**对于正在执行的每个指令，表示其所处的四个阶段。
- **功能单元状态：**表示各功能单元的状态。 每个功能单元在表中维护9个字段：
    + Busy：指示本机是否正在使用
    + Op：在单元中执行的操作（例如MUL，DIV或MOD）
    + Fi：目的地寄存器
    + Fj , Fk：源寄存器编号
    + Qj , Qk：将产生源寄存器Fj , Fk的功能单元
    + Rj , Rk：指示Fj , Fk是否准备就绪的标志
- **寄存器状态：**表示每个寄存器，哪个功能单元将其结果写入。

### 3. 算法
<p>记分牌控制的详细算法如下：</p>

```
Function issue(op, dst, src1, src2) 
    Wait until (!Busy[FU] AND !Result[dst]); // FU can be any functional unit that can execute operation op Busy[FU]  ←  Yes; 
    Op[FU]  ←  op; 
    Fi[FU]  ←  dst; 
    Fj[FU]  ←  src1; 
    Fk[FU]  ←  src2; 
    Qj[FU]  ←  Result[src1]; 
    Qk[FU]  ←  Result[src2]; 
    Rj[FU]  ←  not Qj; 
    Rk[FU]  ←  not Qk; 
    Result[dst]  ←  FU; 
```
```
Function read_operands(FU) 
    Wait until (Rj[FU] AND Rk[FU]); Rj[FU]  ←  No; 
    Rk[FU]  ←  No; 
```
```
Function execute(FU) 
    // Execute whatever FU must do 
```
```
Function write_back(FU) 
    Wait until  (∀f {(Fj[f]≠Fi[FU] OR Rj[f] = No] AND (Fk[f] ≠ Fi[FU] OR Rk[f] = No)]}
    for each f do 
        if   Qj[f]=FU   then   Rj[f]  ←  Yes; 
        if   Qk[f]=FU   then   Rk[f]  ←  Yes; 
    Result[Fi[FU]]  ←  0; 
    Busy[FU]  ←  No; 
```

### 4. 备注
<p>当没有功能单元可用时，记分板方法必须阻止问题阶段。 在这种情况下，未来可能执行的指令将等到结构性危险解决。 一些其他技术，如Tomasulo算法可以避免结构危害，并通过注册重命名解决WAR和WAW依赖关系。</p>

## 实验目的

- 了解动态调度的基本思路
- 了解记分板技术的基本原理和特点
- 掌握记分板技术的实现框架和运行机制
- 掌握记分板技术中指令乱序执行的特点

## 实验内容

1. 定义 NK-CPU 指令流水线记分板仿真的基本数据结构
2. 使用 C 语言实现 NK-CPU 指令流水线记分板仿真程序
3. 使用 NK-CPU 汇编语言编写记分板仿真程序的测试程序
4. 获得测试结果并与实验 3 仿真测试结果进行比较

## 实验要求

1. 同实验 3
2. 同实验 3
3. 指令流水线的功能单元包括 1 个 ALU、2 个浮点乘法器、1 个浮点加法器和 1个浮点除法器。